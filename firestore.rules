rules_version = '2';

// Firestore Security Rules for CoperniGeo
// Last updated: 2025-12-22
// Updated to integrate with Stripe Extension

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user owns the resource
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    // Check if document being created has correct userId
    function hasValidUserId() {
      return request.resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // STRIPE PLAN HELPER FUNCTIONS
    // ============================================
    // Check if user has avanzado plan (via Stripe custom claim)
    function hasAvanzadoPlan() {
      return request.auth != null && request.auth.token.stripeRole == "avanzado";
    }
    
    // Check if user has empresarial plan (via Stripe custom claim)
    function hasEmpresarialPlan() {
      return request.auth != null && request.auth.token.stripeRole == "empresarial";
    }
    
    // Check if user has basic plan via Stripe custom claim
    function hasBasicPlanStripe() {
      return request.auth != null && request.auth.token.stripeRole == "basic";
    }
    
    // Validate area data structure
    function isValidArea() {
      let data = request.resource.data;
      return data.keys().hasAll(['name', 'userId', 'coordinates', 'createdAt', 'updatedAt'])
        && data.name is string
        && data.name.size() > 0
        && data.userId is string
        && data.coordinates is list
        && data.coordinates.size() >= 3
        && data.createdAt is timestamp
        && data.updatedAt is timestamp;
    }
    
    // Validate report data structure
    function isValidReport() {
      let data = request.resource.data;
      return data.keys().hasAll(['userId', 'frequency', 'indices', 'cloudCoverage', 'deliveryMethod', 'areaIds', 'status'])
        && data.userId is string
        && data.frequency is string
        && data.frequency in ['3days', '5days', 'weekly', 'monthly']
        && data.indices is list
        && data.indices.size() > 0
        && data.cloudCoverage is number
        && data.cloudCoverage >= 0 && data.cloudCoverage <= 100
        && data.deliveryMethod is string
        && data.deliveryMethod in ['email', 'whatsapp']
        && data.status is string
        && data.status in ['active', 'paused']
        && data.areaIds is list
        && data.areaIds.size() > 0
        && (
          // If email delivery, email must be present and valid
          (data.deliveryMethod == 'email' && data.email is string && data.email.matches('.*@.*\\..*'))
          ||
          // If WhatsApp delivery, phoneNumber must be present
          (data.deliveryMethod == 'whatsapp' && data.phoneNumber is string && data.phoneNumber.size() >= 10)
        );
    }
    
    // ============================================
    // AREAS COLLECTION
    // ============================================
    // Users can manage their own areas (polygons)
    match /areas/{areaId} {
      // Allow read if user owns the area
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      
      // Allow create if authenticated and userId matches
      allow create: if isAuthenticated() 
                    && hasValidUserId() 
                    && isValidArea();
      
      // Allow update if user owns the area
      allow update: if isAuthenticated() 
                    && isOwner(resource.data.userId)
                    && hasValidUserId()
                    && isValidArea();
      
      // Allow delete if user owns the area
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }
    
    // ============================================
    // REPORTS COLLECTION
    // ============================================
    // Users can manage their own report configurations
    match /reports/{reportId} {
      // Allow read if user owns the report
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      
      // Allow create if authenticated and userId matches
      allow create: if isAuthenticated() 
                    && hasValidUserId()
                    && isValidReport();
      
      // Allow update if user owns the report
      // Also allow server to update (for marking reports as generated)
      allow update: if isAuthenticated() && (
        isOwner(resource.data.userId) // User updating their own report
        || isOwner(request.resource.data.userId) // Server updating report status
      );
      
      // Allow delete if user owns the report
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }
    
    // ============================================
    // CACHE COLLECTION
    // ============================================
    // Satellite imagery cache - restricted to users with active plans
    // Users without plans cannot access satellite imagery (except during CTA flow, handled server-side)
    match /cache/{cacheId} {
      // Only users with active plans can read cache
      // Checks: Stripe custom claims (avanzado, empresarial) OR basic plan in userPlans
      allow read: if isAuthenticated() && (
        hasAvanzadoPlan() ||
        hasEmpresarialPlan() ||
        hasBasicPlanStripe() ||
        // Check userPlans collection for basic plan (free, no Stripe)
        (exists(/databases/$(database)/documents/userPlans/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/userPlans/$(request.auth.uid)).data.status == 'active' &&
         get(/databases/$(database)/documents/userPlans/$(request.auth.uid)).data.planType == 'basic')
      );
      
      // Only server (via Admin SDK) can write
      // Client writes are blocked
      allow write: if false;
    }
    
    // ============================================
    // USERS COLLECTION (if you add user profiles)
    // ============================================
    match /users/{userId} {
      // Users can read their own profile
      allow read: if isAuthenticated() && isOwner(userId);
      
      // Users can create/update their own profile
      allow create, update: if isAuthenticated() && isOwner(userId);
      
      // Users can delete their own profile
      allow delete: if isAuthenticated() && isOwner(userId);
    }
    
    // ============================================
    // USER PLANS COLLECTION
    // ============================================
    // Legacy userPlans collection (for basic plan that doesn't use Stripe)
    match /userPlans/{planId} {
      // Users can read their own plans
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      
      // Users can create their own plan (for basic plan signup - free, no Stripe)
      allow create: if isAuthenticated() 
                    && hasValidUserId()
                    && request.resource.data.keys().hasAll(['userId', 'planType', 'startDate', 'endDate', 'status', 'createdAt', 'updatedAt'])
                    && request.resource.data.planType is string
                    && request.resource.data.planType in ['basic', 'professional', 'enterprise']
                    && request.resource.data.status is string
                    && request.resource.data.status == 'active';
      
      // Users can update their own plan
      allow update: if isAuthenticated() 
                   && isOwner(resource.data.userId)
                   && hasValidUserId();
      
      // Users cannot delete plans (only server can)
      allow delete: if false;
    }
    
    // ============================================
    // STRIPE EXTENSION COLLECTIONS
    // ============================================
    // Stripe customer data - users can only access their own
    match /customers/{uid} {
      allow read: if isAuthenticated() && request.auth.uid == uid;

      match /checkout_sessions/{id} {
        allow read, write: if isAuthenticated() && request.auth.uid == uid;
      }
      
      match /subscriptions/{id} {
        allow read: if isAuthenticated() && request.auth.uid == uid;
      }
      
      match /payments/{id} {
        allow read: if isAuthenticated() && request.auth.uid == uid;
      }
    }

    // Stripe products and prices - public read access
    match /products/{id} {
      allow read: if true;
      allow write: if false; // Only Stripe extension can write
    }

    match /prices/{id} {
      allow read: if true;
      allow write: if false; // Only Stripe extension can write
    }

    match /tax_rates/{id} {
      allow read: if true;
      allow write: if false; // Only Stripe extension can write
    }
    
    // ============================================
    // SHORT LINKS COLLECTION
    // ============================================
    // Short links for report URLs - public read access for redirects
    match /shortLinks/{linkId} {
      // Public read access (anyone can read to get the long URL for redirect)
      allow read: if true;
      
      // Only server (via Admin SDK) can create/update/delete
      // Client writes are blocked
      allow write: if false;
    }
    
    // ============================================
    // LEADS COLLECTION (No authentication required)
    // ============================================
    match /leads/{leadId} {
      // Anyone can create a lead (for free report conversion flow)
      // No authentication required
      allow create: if request.resource.data.keys().hasAll(['email', 'country', 'status', 'createdAt', 'updatedAt'])
                    && request.resource.data.email is string
                    && request.resource.data.email.matches('.*@.*\\..*')
                    && request.resource.data.country is string
                    && request.resource.data.country.size() > 0
                    && request.resource.data.status is string
                    && request.resource.data.status in ['lead', 'snapshot_requested', 'needs_manual_mapping']
                    && request.resource.data.createdAt is timestamp
                    && request.resource.data.updatedAt is timestamp;
      
      // Allow update for geometry and status (for conversion flow)
      // Only allow updating specific fields: geometry, status, updatedAt
      // Email and country cannot be changed
      allow update: if request.resource.data.email == resource.data.email
                    && request.resource.data.country == resource.data.country
                    && request.resource.data.status is string
                    && request.resource.data.status in ['lead', 'snapshot_requested', 'needs_manual_mapping']
                    && request.resource.data.updatedAt is timestamp;
      
      // No reads or deletes from client (only server can)
      allow read, delete: if false;
    }
    
    // ============================================
    // DEFAULT DENY (Security by default)
    // ============================================
    // Any collection not explicitly allowed above is denied
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
